/*! d3.chart.layout - v0.1.0
 *  https://github.com/bansaghi/d3.chart.layout/
 *  
 *  Copyright (c) 2014 Anna Bansaghi
 *  License under the BSD license.
 */
d3.chart("hierarchy",{initialize:function(){this.d3={},this.layers={},this.base.attr("width",this.base.node().parentNode.clientWidth),this.base.attr("height",this.base.node().parentNode.clientHeight),this.d3.zoom=d3.behavior.zoom(),this.layers.base=this.base.append("g"),this.name(this._name||"name"),this.value(this._value||"value"),this.duration(this._duration||750)},name:function(a){return arguments.length?(this._name=a,this.trigger("change:name"),this.root&&this.draw(this.root),this):this._name},value:function(a){return arguments.length?(this._value=a,this.trigger("change:value"),this.root&&this.draw(this.root),this):this._value},duration:function(a){return arguments.length?(this._duration=a,this.trigger("change:duration"),this.root&&this.draw(this.root),this):this._duration},zoomable:function(a){function b(){c.layers.base.attr("transform","translate("+d3.event.translate+") scale("+d3.event.scale+")")}var c=this,d=a||[0,1/0];return c.base.call(c.d3.zoom.scaleExtent(d).on("zoom",b)),c}}),d3.chart("hierarchy").extend("cluster-tree",{initialize:function(){var a=this,b=0;a.radius(a._radius||4.5),a._width=a.base.attr("width"),a._height=a.base.attr("height"),a.layers.links=a.layers.base.append("g").classed("links",!0),a.layers.nodes=a.layers.base.append("g").classed("nodes",!0),a.layer("nodes",a.layers.nodes,{dataBind:function(a){return this.selectAll(".node").data(a,function(a){return a._id||(a._id=++b)})},insert:function(){return this.append("g").classed("node",!0)},events:{enter:function(){this.append("circle").attr("r",0).style("fill",function(a){return a._children?"lightsteelblue":"#fff"}),this.append("text").attr("dy",".35em").text(function(b){return b[a._name]}).style("fill-opacity",0)},"merge:transition":function(){this.select("circle").attr("r",a._radius).style("fill",function(a){return a._children?"lightsteelblue":"#fff"}),this.select("text").style("fill-opacity",1)},"exit:transition":function(){this.duration(a._duration).remove(),this.select("circle").attr("r",0),this.select("text").style("fill-opacity",0)}}}),a.layer("links",a.layers.links,{dataBind:function(b){return this.selectAll(".link").data(a.d3.layout.links(b),function(a){return a.target._id})},insert:function(){return this.append("path").classed("link",!0)},events:{enter:function(){this.attr("d",function(){var b={x:a.source.x0,y:a.source.y0};return a.d3.diagonal({source:b,target:b})})},"merge:transition":function(){this.duration(a._duration).attr("d",a.d3.diagonal)},"exit:transition":function(){this.duration(a._duration).attr("d",function(){var b={x:a.source.x,y:a.source.y};return a.d3.diagonal({source:b,target:b})}).remove()}}})},radius:function(a){return arguments.length?(this._radius=a,this.trigger("change:radius"),this.root&&this.draw(this.root),this):this._radius},collapsible:function(){function a(a){d3.event.defaultPrevented||(a=b(a),d.trigger("transform:stash"),d.draw(a))}function b(a){return a.children?(a._children=a.children,a.children=null):a._children&&(a.children=a._children,a._children=null),a}function c(a){a.children&&(a._children=a.children,a._children.forEach(c),a.children=null)}var d=this;return d.layers.nodes.on("merge",function(){this.on("click",a)}),d.once("collapse:init",function(){d.root.children.forEach(c)}),this}}),d3.chart("cluster-tree").extend("cluster-tree.cartesian",{initialize:function(){var a=this;a.margin(a._margin||{}),a.d3.diagonal=d3.svg.diagonal().projection(function(a){return[a.y,a.x]}),a.layers.nodes.on("enter",function(){this.attr("transform",function(){return"translate("+a.source.y0+","+a.source.x0+")"}),this.select("text").attr("x",function(a){return a.children||a._children?-10:10}).attr("text-anchor",function(a){return a.children||a._children?"end":"start"})}),a.layers.nodes.on("merge:transition",function(){this.duration(a._duration).attr("transform",function(a){return"translate("+a.y+","+a.x+")"})}),a.layers.nodes.on("exit:transition",function(){this.attr("transform",function(){return"translate("+a.source.y+","+a.source.x+")"})}),a.on("change:margin",function(){a._width=a.base.attr("width")-a._margin.left-a._margin.right,a._height=a.base.attr("height")-a._margin.top-a._margin.bottom,a.base.attr("transform","translate("+a._margin.left+","+a._margin.top+")")})},transform:function(a){var b=this;b.source=a,b.root||(b.root=a,b.root.x0=b._height/2,b.root.y0=0,b.trigger("collapse:init"));var c=b.d3.layout.size([b._height,b._width]).nodes(b.root).reverse();return b.on("transform:stash",function(){c.forEach(function(a){a.x0=a.x,a.y0=a.y})}),c},margin:function(a){return arguments.length?(["top","right","bottom","left"].forEach(function(b){b in a&&(this[b]=a[b])},this._margin={top:0,right:0,bottom:0,left:0}),this.trigger("change:margin"),this.root&&this.draw(this.root),this):this._margin}}),d3.chart("cluster-tree").extend("cluster-tree.radial",{initialize:function(){var a=this;a.diameter(a._diameter||Math.min(a._width,a._height)),a.d3.diagonal=d3.svg.diagonal.radial().projection(function(a){return[a.y,a.x/180*Math.PI]}),a.d3.zoom.translate([a._diameter/2,a._diameter/2]),a.layers.base.attr("transform","translate("+a._diameter/2+","+a._diameter/2+")"),a.layers.nodes.on("enter",function(){this.attr("transform",function(){return"rotate("+(a.source.x0-90)+")translate("+a.source.y0+")"}),this.select("text").attr("text-anchor",function(a){return a.x<180?"start":"end"}).attr("transform",function(a){return a.x<180?"translate(8)":"rotate(180)translate(-8)"})}),a.layers.nodes.on("merge:transition",function(){this.duration(a._duration).attr("transform",function(a){return"rotate("+(a.x-90)+")translate("+a.y+")"})}),a.layers.nodes.on("exit:transition",function(){this.attr("transform",function(){return"rotate("+(a.source.x-90)+")translate("+a.source.y+")"})})},transform:function(a){var b=this;b.source=a,b.root||(b.root=a,b.root.x0=360,b.root.y0=0,b.trigger("collapse:init"));var c=b.d3.layout.size([360,b._diameter/4]).separation(function(a,b){return 0===a.depth?1:(a.parent==b.parent?1:2)/a.depth}).nodes(b.root).reverse();return b.on("transform:stash",function(){c.forEach(function(a){a.x0=a.x,a.y0=a.y})}),c},diameter:function(a){return arguments.length?(this._diameter=a,this.trigger("change:diameter"),this.root&&this.draw(this.root),this):this._diameter}}),d3.chart("cluster-tree.cartesian").extend("cluster.cartesian",{initialize:function(){this.d3.layout=d3.layout.cluster()}}),d3.chart("cluster-tree.radial").extend("cluster.radial",{initialize:function(){this.d3.layout=d3.layout.cluster()}}),d3.chart("hierarchy").extend("pack.flattened",{initialize:function(){var a=this;a.d3.layout=d3.layout.pack(),a._width=a.base.attr("width"),a._height=a.base.attr("height"),a.flatten(a._flatten||null),a.formats(a._formats||{}),a.diameter(a._diameter||Math.min(a._width,a._height)),a.d3.zoom.translate([(a._width-a._diameter)/2,(a._height-a._diameter)/2]),a.layers.base.attr("transform","translate("+(a._width-a._diameter)/2+","+(a._height-a._diameter)/2+")"),a.layer("base",a.layers.base,{dataBind:function(a){return this.selectAll(".node").data(a.filter(function(a){return!a.children}))},insert:function(){return this.append("g")},events:{enter:function(){this.attr("transform",function(a){return"translate("+a.x+","+a.y+")"}),this.append("circle").attr("r",function(a){return a.r}),this.append("text").attr("dy",".3em").style("text-anchor","middle")},merge:function(){this.select("text").text(function(b){return b[a._name].substring(0,b.r/3)}),this.append("title").text(a._formats.title),this.select("circle").style("fill",a._formats.fill)}}}),a.on("change:diameter",function(){a.layers.base.attr("transform","translate("+(a._width-a._diameter)/2+","+(a._height-a._diameter)/2+")")})},transform:function(a){var b=this;return b.root=a,b.d3.layout.size([b._diameter,b._diameter]).sort(null).padding(1.5).value(function(a){return a[b._value]}).nodes(b._flatten?b._flatten(a):a)},diameter:function(a){return arguments.length?(this._diameter=a-10,this.trigger("change:diameter"),this.root&&this.draw(this.root),this):this._diameter},flatten:function(a){return arguments.length?(this._flatten=a,this.trigger("change:flatten"),this.root&&this.draw(this.root),this):this._flatten},formats:function(a){if(!arguments.length)return this._formats;var b=this,c=d3.scale.category20c();return["title","fill"].forEach(function(b){b in a&&(this[b]=d3.functor(a[b]))},this._formats={title:function(a){return a[b._value]},fill:function(a){return c(a[b._name])}}),this.trigger("change:formats"),this.root&&this.draw(this.root),this}}),d3.chart("hierarchy").extend("pack.nested",{initialize:function(){var a=this;a.d3.layout=d3.layout.pack(),a._width=a.base.attr("width"),a._height=a.base.attr("height"),a.diameter(a._diameter||Math.min(a._width,a._height)),a.d3.zoom.translate([(a._width-a._diameter)/2,(a._height-a._diameter)/2]),a.layers.base.attr("transform","translate("+(a._width-a._diameter)/2+","+(a._height-a._diameter)/2+")"),a.layer("base",a.layers.base,{dataBind:function(a){return this.selectAll(".node").data(a)},insert:function(){return this.append("g")},events:{enter:function(){this.attr("transform",function(a){return"translate("+a.x+","+a.y+")"}),this.append("circle").attr("r",function(a){return a.r}),this.append("text").attr("dy",".3em").style("text-anchor","middle")},merge:function(){this.attr("class",function(a){return a.children?"node parent":"node child"}),this.select("text").style("opacity",function(a){return a.r>20?1:0}).text(function(b){return b[a._name]})}}}),a.on("change:diameter",function(){a.layers.base.attr("transform","translate("+(a._width-a._diameter)/2+","+(a._height-a._diameter)/2+")")})},transform:function(a){var b=this;return b.root=a,b.d3.layout.size([b._diameter,b._diameter]).value(function(a){return a[b._value]}).nodes(a)},diameter:function(a){return arguments.length?(this._diameter=a-10,this.trigger("change:diameter"),this.root&&this.draw(this.root),this):this._diameter},collapsible:function(){function a(a){var f=c._diameter/a.r/2;d.domain([a.x-a.r,a.x+a.r]),e.domain([a.y-a.r,a.y+a.r]);var g=c.layers.base.transition().duration(c._duration);g.selectAll(".node").attr("transform",function(a){return"translate("+d(a.x)+","+e(a.y)+")"}),g.selectAll("circle").attr("r",function(a){return f*a.r}),g.selectAll("text").style("opacity",function(a){return f*a.r>20?1:0}),b=a,d3.event.stopPropagation()}var b,c=this,d=d3.scale.linear().range([0,c._diameter]),e=d3.scale.linear().range([0,c._diameter]);return c.layers.base.on("merge",function(){b=c.root,this.on("click",function(d){a(b==d?c.root:d)})}),d3.select(window).on("click",function(){a(c.root)}),this}}),d3.chart("hierarchy").extend("partition.arc",{initialize:function(){var a=this;a.d3.layout=d3.layout.partition(),a._width=a.base.attr("width"),a._height=a.base.attr("height"),a.diameter(a._diameter||Math.min(a._width,a._height));var b=d3.scale.category20c();a.d3.x=d3.scale.linear().range([0,2*Math.PI]),a.d3.y=d3.scale.sqrt().range([0,a._diameter/2]),a.d3.arc=d3.svg.arc().startAngle(function(b){return Math.max(0,Math.min(2*Math.PI,a.d3.x(b.x)))}).endAngle(function(b){return Math.max(0,Math.min(2*Math.PI,a.d3.x(b.x+b.dx)))}).innerRadius(function(b){return Math.max(0,a.d3.y(b.y))}).outerRadius(function(b){return Math.max(0,a.d3.y(b.y+b.dy))}),a.d3.zoom.translate([a.base.attr("width")/2,a.base.attr("height")/2]),a.layers.base.attr("transform","translate("+a.base.attr("width")/2+","+a.base.attr("height")/2+")"),a.layer("base",a.layers.base,{dataBind:function(a){return this.selectAll("path").data(a)},insert:function(){return this.append("path")},events:{enter:function(){this.attr("d",a.d3.arc).style("fill",function(c){return b((c.children?c:c.parent)[a._name])})}}}),a.on("change:radius",function(){a.layers.paths.attr("transform","translate("+a.base.attr("width")/2+","+a.base.attr("height")/2+")"),a.d3.y=d3.scale.sqrt().range([0,a._diameter/2])})},transform:function(a){var b=this;return b.root=a,b.d3.layout.value(function(a){return a[b._value]}).nodes(a)},diameter:function(a){return arguments.length?(this._diameter=a-10,this.trigger("change:radius"),this.root&&this.draw(this.root),this):this._diameter},collapsible:function(){function a(a){var c=d3.interpolate(b.d3.x.domain(),[a.x,a.x+a.dx]),d=d3.interpolate(b.d3.y.domain(),[a.y,1]),e=d3.interpolate(b.d3.y.range(),[a.y?20:0,b._diameter/2]);return function(a,f){return f?function(){return b.d3.arc(a)}:function(f){return b.d3.x.domain(c(f)),b.d3.y.domain(d(f)).range(e(f)),b.d3.arc(a)}}}var b=this;return b.layers.base.on("merge",function(){var c=this;this.on("click",function(d){c.transition().duration(b._duration).attrTween("d",a(d))})}),this}}),d3.chart("hierarchy").extend("partition.rectangle",{initialize:function(){var a=this;a.d3.layout=d3.layout.partition(),a._width=a.base.attr("width"),a._height=a.base.attr("height");var b=d3.scale.linear().range([0,a._width]),c=d3.scale.linear().range([0,a._height]);a.d3.transform=function(a,b){return"translate(8,"+a.dx*b/2+")"},a.layer("base",a.layers.base,{dataBind:function(a){return this.selectAll(".partition").data(a)},insert:function(){return this.append("g").classed("partition",!0).attr("transform",function(a){return"translate("+b(a.y)+","+c(a.x)+")"})},events:{enter:function(){var b=a._width/a.root.dx,c=a._height/1;this.append("rect").attr("class",function(a){return a.children?"parent":"child"}).attr("width",a.root.dy*b).attr("height",function(a){return a.dx*c}),this.append("text").attr("transform",function(b){return a.d3.transform(b,c)}).attr("dy",".35em").style("opacity",function(a){return a.dx*c>12?1:0}).text(function(b){return b[a._name]})}}})},transform:function(a){var b=this;return b.root=a,b.d3.layout.value(function(a){return a[b._value]}).nodes(a)},collapsible:function(){function a(a){if(a.children){var e=(a.y?b._width-40:b._width)/(1-a.y),f=b._height/a.dx;c.domain([a.y,1]).range([a.y?40:0,b._width]),d.domain([a.x,a.x+a.dx]);var g=b.layers.base.transition().duration(b._duration);g.selectAll(".partition").attr("transform",function(a){return"translate("+c(a.y)+","+d(a.x)+")"}),g.selectAll("rect").attr("width",a.dy*e).attr("height",function(a){return a.dx*f}),g.selectAll("text").attr("transform",function(a){return b.d3.transform(a,f)}).style("opacity",function(a){return a.dx*f>12?1:0}),d3.event.stopPropagation()}}var b=this,c=d3.scale.linear(),d=d3.scale.linear().range([0,b._height]);return b.layers.base.on("merge",function(){this.on("click",a)}),d3.select(window).on("click",function(){a(b.root)}),this}}),d3.chart("cluster-tree.cartesian").extend("tree.cartesian",{initialize:function(){this.d3.layout=d3.layout.tree()}}),d3.chart("cluster-tree.radial").extend("tree.radial",{initialize:function(){this.d3.layout=d3.layout.tree()}}),d3.chart("hierarchy").extend("treemap",{initialize:function(){var a=this;a.d3.layout=d3.layout.treemap(),a._width=a.base.attr("width"),a._height=a.base.attr("height");var b=d3.scale.category20c();a.layer("base",a.layers.base,{dataBind:function(a){return this.selectAll(".cell").data(a)},insert:function(){return this.append("g").classed("cell",!0).attr("transform",function(a){return"translate("+a.x+","+a.y+")"})},events:{enter:function(){this.append("rect").attr("width",function(a){return a.dx}).attr("height",function(a){return a.dy}).attr("fill",function(c){return c.parent?b(c.parent[a._name]):null}),this.append("text").attr("x",function(a){return a.dx/2}).attr("y",function(a){return a.dy/2}).attr("dy",".35em").attr("text-anchor","middle").text(function(b){return b.children?null:b[a._name]}).style("opacity",function(a){return a.w=this.getComputedTextLength(),a.dx>a.w?1:0})}}})},transform:function(a){var b=this;return b.root=a,b.d3.layout.round(!1).size([b._width,b._height]).sticky(!0).value(function(a){return a[b._value]}).nodes(a)},collapsible:function(){function a(a){var f=c._width/a.dx,g=c._height/a.dy;d.domain([a.x,a.x+a.dx]),e.domain([a.y,a.y+a.dy]);var h=c.layers.base.transition().duration(c._duration);h.selectAll(".cell").attr("transform",function(a){return"translate("+d(a.x)+","+e(a.y)+")"}),h.selectAll("rect").attr("width",function(a){return f*a.dx}).attr("height",function(a){return g*a.dy}),h.selectAll("text").attr("x",function(a){return f*a.dx/2}).attr("y",function(a){return g*a.dy/2}).style("opacity",function(a){return f*a.dx>a.w?1:0}),b=a,d3.event.stopPropagation()}var b,c=this,d=d3.scale.linear().range([0,c._width]),e=d3.scale.linear().range([0,c._height]);return c.layers.base.on("merge",function(){b=c.root,this.on("click",function(d){a(b==d.parent?c.root:d.parent)})}),d3.select(window).on("click",function(){a(c.root)}),this}});